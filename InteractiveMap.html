<!DOCTYPE html>
<head>
    <title>D3 Mapping Timeline</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="d3.slider.css" />
    <style>

        path {
            fill: none;
            stroke: #333;
            stroke-width: .5px;
        }

        .land-boundary {
            stroke-width: 1px;
        }

        .county-boundary {
            stroke: #ddd;
        }

        .site {
            stroke-width: .5px;
            stroke: #333;
            fill: #9cf;
        }

        #slider3 {
            margin: 20px 0 10px 20px;
            width: 900px;
        }

    </style>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.3/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script src="d3.slider.js"></script>
</head>


<body>

<div id="slider3"></div>


<script>

    var width = 960,
        height = 600;

    //var mapPath = "/data/us-10m.json";
    var mapPath = "https://raw.githubusercontent.com/weslleylc/Pokemon-Go-Visualization/master/data/us-10m.json";

    var projection = d3.geo.albersUsa()
        .scale(1280)
        .translate([width / 2, height / 2]);

    var path = d3.geo.path()
        .projection(projection);

    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height);

    var format = d3.time.format("%Y-%m-%dT%H:%M:%S");

    d3.json(mapPath, function(error, us) {
        if (error) return console.error(error);

        svg.append("path")
            .datum(topojson.feature(us, us.objects.land))
            .attr("d", path)
            .attr("class", "land-boundary");

        svg.append("path")
            .datum(topojson.mesh(us, us.objects.counties, function(a, b) { return a !== b && (a.id / 1000 | 0) === (b.id / 1000 | 0); }))
            .attr("d", path)
            .attr("class", "county-boundary");

        svg.append("path")
            .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
            .attr("d", path)
            .attr("class", "state-boundary");


        d3.csv("data/pokemon_appears_US.csv")
            .row(function(d) {
                //console.log(d.appearedLocalTime)
                return {
                    permalink: d._id,
                    lat: parseFloat(d.latitude),
                    lng: parseFloat(d.longitude),
                    city: d.city,
                    created_at: format.parse(d.appearedLocalTime)
                };
            })
            .get(function(err, rows) {
                if (err) return console.error(err);

                window.site_data = rows;
            });
    });

    var displaySites = function(data) {
        console.log(data);
        var sites = svg.selectAll(".site")
            .data(data, function(d) {
                return d.permalink;
            });

        sites.enter().append("circle")
            .attr("class", "site")
            .attr("cx", function(d) {
                //console.log(d);
                return projection([d.lng, d.lat])[0];
            })
            .attr("cy", function(d) {
                return projection([d.lng, d.lat])[1];
            })
            .attr("r", 1)
            .transition().duration(400)
            .attr("r", 5);

        sites.exit()
            .transition().duration(200)
            .attr("r",1)
            .remove();
    };

    var startDate = format.parse("2016-09-02T21:50:07");
    var endDate = format.parse("2016-09-08T03:57:25");
    var secondsInDay = 60 * 60 * 24;
    timeScale = d3.time.scale().domain([startDate, endDate]);
    //console.log(startDate);
    d3.select('#slider3').call(d3.slider()
        //.time.scale().domain([startDate, endDate])
        .min(startDate)
        .max(endDate)
        .step(secondsInDay)
        .on("slide", function(evt, value) {
            var newData = _(site_data).filter( function(site) {

                return site.created_at < value && site.created_at > value-(60*60*60*5);
            });
            //console.log("New set size ", newData);

            displaySites(newData);
        })
    );

</script>
</body>
