<!DOCTYPE html>
<head>
    <title>D3 Mapping Timeline</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="d3.slider.css" />
    <style>

        path {
            fill: none;
            stroke: #333;
            stroke-width: .5px;
        }

        .land-boundary {
            stroke-width: 1px;
        }

        .county-boundary {
            stroke: #ddd;
        }

        .site {
            stroke-width: .5px;
            stroke: #333;
            fill: #9cf;
        }

        #slider3 {
            margin: 20px 0 10px 20px;
            width: 900px;
        }

        #play-button {
            position: relative;
            top: 100px;
            left: 10px;
            background: #f08080;
            padding-right: 26px;
            border-radius: 3px;
            border: none;
            color: white;
            margin: 0;
            width: 60px;
            cursor: pointer;
            height: 30px;
        }

        #play-button:hover {
            background-color: #696969;
        }

        #time-container {
            position: relative;
            top: 30px;
            left: 570px;
            padding-right: 26px;
            border-radius: 3px;
            margin: 0;
        }

    </style>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.3/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/js/bootstrap-datetimepicker.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/css/bootstrap-datetimepicker.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="d3.slider.js"></script>
</head>


<body>

<div>
    <button id="play-button">Play</button>
    <div id="slider3"></div>
    <div class="container" id="time-container">
        <div class="row">
            <div class='col-sm-6'>
                <div class="form-group">
                    <div class='input-group date' id='datetimepicker5'>
                        <input type='text' class="form-control" />
                        <span class="input-group-addon">
                        <span class="glyphicon glyphicon-calendar"></span>
                    </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    var width = 960,
        height = 600;

    //var mapPath = "/data/us-10m.json";
    var mapPath = "https://raw.githubusercontent.com/weslleylc/Pokemon-Go-Visualization/master/data/us-10m.json";

    var projection = d3.geo.albersUsa()
        .scale(1280)
        .translate([width / 2, height / 2]);

    var path = d3.geo.path()
        .projection(projection);

    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height);
    var playButton = d3.select("#play-button");
    var format = d3.time.format("%Y-%m-%dT%H:%M:%S");

    d3.json(mapPath, function(error, us) {
        if (error) return console.error(error);

        svg.append("path")
            .datum(topojson.feature(us, us.objects.land))
            .attr("d", path)
            .attr("class", "land-boundary");

        svg.append("path")
            .datum(topojson.mesh(us, us.objects.counties, function(a, b) { return a !== b && (a.id / 1000 | 0) === (b.id / 1000 | 0); }))
            .attr("d", path)
            .attr("class", "county-boundary");

        svg.append("path")
            .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
            .attr("d", path)
            .attr("class", "state-boundary");


        d3.csv("data/pokemon_appears_US.csv")
            .row(function(d) {
                //console.log(d.appearedLocalTime)
                return {
                    permalink: d._id,
                    lat: parseFloat(d.latitude),
                    lng: parseFloat(d.longitude),
                    number: d.pokemonId,
                    city: d.city,
                    created_at: format.parse(d.appearedLocalTime)
                };
            })
            .get(function(err, rows) {
                if (err) return console.error(err);

                window.site_data = rows;
            });
    });

    var displaySites = function(data) {
        //console.log(data);'
        var sites = svg.selectAll(".site")
            .data(data, function(d) {
                return d.permalink;
            });

        // sites.enter().append("circle")
        //     .attr("class", "site")
        //     .attr("cx", function(d) {
        //         //console.log(d);
        //         return projection([d.lng, d.lat])[0];
        //     })
        //     .attr("cy", function(d) {
        //         return projection([d.lng, d.lat])[1];
        //     })
        //     .attr("r", 1)
        //     .transition().duration(400)
        //     .attr("r", 5);
        sites.enter().append('svg:image')
            .attr("class", "site")
            .attr("href", function(d){
                return "data/figures/"+d.number+".png"
            })
            .attr("x", function(d) {
                //console.log("TEste");
                return projection([d.lng, d.lat])[0];
            })
            .attr("y", function(d) {
                return projection([d.lng, d.lat])[1];
            })
            .attr("width", 30)
            .attr("height", 30);

        sites.exit()
            .remove();
    };

    var startDate = format.parse("2016-09-02T21:50:07");
    var endDate = format.parse("2016-09-08T03:57:25");
    var secondsInDay = 60 * 60 * 24;
    var actualDate = startDate.getTime();
    var step = 1000* 60;// * 30;
    timeScale = d3.time.scale().domain([startDate, endDate]);
    //console.log(startDate);
    var myslider = d3.slider()
    //.time.scale().domain([startDate, endDate])
        .min(startDate)
        .max(endDate)
        .step(secondsInDay)
        .on("slide", function(evt, value) {
            var newData = _(site_data).filter( function(site) {
                actualDate = myslider.value();
                return site.created_at < value && site.created_at > value-step;
            });
            //console.log("New set size ", newData);
            displaySites(newData);
            $('#datetimepicker5').data("DateTimePicker").date(new Date(actualDate));
        });
    d3.select('#slider3').call(myslider);

    function update(){
        //console.log(actualDate);
        actualDate = actualDate + step;
        $('#datetimepicker5').data("DateTimePicker").date(new Date(actualDate));
        var newData = _(site_data).filter( function(site) {
            return site.created_at < actualDate && site.created_at > actualDate-step;
        });
        //console.log("New set size ", newData);
        displaySites(newData);
        myslider.value(actualDate);
        if(actualDate > endDate){
            moving = false;
            clearInterval(timer);
            // timer = 0;
            playButton.text("Play");
        }
    }


     playButton.on("click", function() {
         if (actualDate !=  startDate.getTime()){
             actualDate =  myslider.value();
         }
        var button = d3.select(this);
        if (button.text() == "Pause") {
          moving = false;
          clearInterval(timer);
          // timer = 0;
          button.text("Play");
        } else {
          moving = true;
          timer = setInterval(update, 1000);          
          button.text("Pause");
        }
        console.log("Slider moving: " + moving);
      });

    $('#datetimepicker5').datetimepicker({
        useCurrent: false, //this is important as the functions sets the default date value to the current value
        format: 'DD/MM/YY HH:mm',
        defaultDate: startDate,
        minDate: startDate,
        maxDate: endDate
    });

    $("#datetimepicker5").on("dp.change", function (e) {
        actualDate = $('#datetimepicker5').data("DateTimePicker").date().unix()*1000;
        var newData = _(site_data).filter( function(site) {
            return site.created_at < actualDate && site.created_at > actualDate-step;
        });
        displaySites(newData);
        myslider.value(actualDate);
    });
</script>
</body>
